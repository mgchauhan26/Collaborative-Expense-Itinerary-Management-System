{% extends 'base.html' %}

{% block title %}{{ group.name }} - TripMates{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-start">
  <div>
    <h2>{{ group.name }}</h2>
    <p class="text-muted">{{ group.description or '' }}</p>
    <p><strong>Admin:</strong> {{ group.admin.name }}</p>
  </div>
  <div>
    {% if group.admin_id == current_user.id %}
    <form method="post" action="{{ url_for('delete_group', group_id=group.id) }}"
      onsubmit="return confirm('Are you sure you want to delete this group? This action cannot be undone and will delete all associated trips, messages, and members.');"
      class="d-inline">
      <button type="submit" class="btn btn-danger">
        <i class="fas fa-trash-alt"></i> Delete Group
      </button>
    </form>
    {% elif is_member %}
    <form method="post" action="{{ url_for('leave_group', group_id=group.id) }}"
      onsubmit="return confirm('Leave group?');" class="d-inline">
      <button class="btn btn-outline-danger">Leave Group</button>
    </form>
    {% else %}
    <form method="post" action="{{ url_for('join_group', group_id=group.id) }}" class="d-inline">
      <button class="btn btn-primary">Join Group</button>
    </form>
    {% endif %}
  </div>
</div>

<div class="mt-4">
  <div class="card shadow-sm border-0 bg-light">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="card-title text-primary fw-bold mb-0">
          <i class="fas fa-share-alt me-2"></i> Invite Friends
        </h6>
        {% if group.admin_id == current_user.id %}
        <div class="d-flex align-items-center">
          <form method="post" action="{{ url_for('toggle_group_approval', group_id=group.id) }}" class="me-2">
            <button type="submit"
              class="btn btn-sm {{ 'btn-warning' if group.approval_required else 'btn-outline-secondary' }}">
              <i class="fas {{ 'fa-lock' if group.approval_required else 'fa-lock-open' }} me-1"></i>
              {{ 'Approvals: ON' if group.approval_required else 'Approvals: OFF' }}
            </button>
          </form>
          <form method="post" action="{{ url_for('reset_group_link', group_id=group.id) }}"
            onsubmit="return confirm('Old links will stop working. Continue?');">
            <button type="submit" class="btn btn-sm btn-outline-danger">
              <i class="fas fa-sync-alt me-1"></i> Reset Link
            </button>
          </form>
        </div>
        {% endif %}
      </div>
      <p class="small text-muted mb-3">Share this special link with your friends. They'll be able to join this group,
        see all trips, and chat in real-time!</p>

      <div class="input-group">
        <input type="text" class="form-control bg-white" id="invite-link"
          value="{{ url_for('join_group', token=group.join_token, _external=True) }}" readonly>
        <button class="btn btn-primary" type="button" onclick="copyInviteLink()">
          <i class="fas fa-copy me-1"></i> Copy Link
        </button>
      </div>
      <div id="copy-status" class="small text-success mt-2" style="display: none;">
        <i class="fas fa-check-circle me-1"></i> Link copied to clipboard!
      </div>
    </div>
  </div>
</div>

<script>
  function copyInviteLink() {
    const linkInput = document.getElementById('invite-link');
    linkInput.select();
    linkInput.setSelectionRange(0, 99999); // For mobile devices

    navigator.clipboard.writeText(linkInput.value).then(() => {
      const status = document.getElementById('copy-status');
      status.style.display = 'block';
      setTimeout(() => {
        status.style.display = 'none';
      }, 3000);
    });
  }
</script>

{% if group.admin_id == current_user.id and pending_requests %}
<div class="mt-4">
  <h5 class="text-warning">
    <i class="fas fa-user-clock me-2"></i> Pending Requests ({{ pending_requests|length }})
  </h5>
  <div class="card shadow-sm border-warning">
    <div class="list-group list-group-flush">
      {% for user, member in pending_requests %}
      <div class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ user.name }}</strong> <small class="text-muted">({{ user.email }})</small>
        </div>
        <div>
          <form method="post" action="{{ url_for('approve_join_request', group_id=group.id, user_id=user.id) }}"
            class="d-inline">
            <button type="submit" class="btn btn-sm btn-success">Approve</button>
          </form>
          <form method="post" action="{{ url_for('reject_join_request', group_id=group.id, user_id=user.id) }}"
            class="d-inline">
            <button type="submit" class="btn btn-sm btn-outline-danger">Reject</button>
          </form>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

<div class="mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Members ({{ members|length }})</h5>
  </div>
  {% if members %}
  <div class="card">
    <div class="list-group list-group-flush">
      {% for member in members %}
      <div class="list-group-item d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <div class="me-3">
            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"
              style="width: 40px; height: 40px; font-weight: bold;">
              {{ member.user.name[0].upper() }}
            </div>
          </div>
          <div>
            <div class="fw-bold">{{ member.user.name }}</div>
            <small class="text-muted">
              <i class="fas fa-calendar-alt me-1"></i>
              Joined {{ member.joined_at.strftime('%b %d, %Y') if member.joined_at else 'Recently' }}
            </small>
          </div>
        </div>
        <div class="d-flex align-items-center">
          {% if member.is_admin or member.user.id == group.admin_id %}
          <span class="badge bg-success me-2">
            <i class="fas fa-crown me-1"></i>Admin
          </span>
          {% elif member.role == 'admin' %}
          <span class="badge bg-primary me-2">
            <i class="fas fa-user-shield me-1"></i>Admin
          </span>
          {% else %}
          <span class="badge bg-secondary me-2">
            <i class="fas fa-user me-1"></i>Member
          </span>
          {% endif %}

          {% if group.admin_id == current_user.id and member.user.id != current_user.id %}
          <form method="post" action="{{ url_for('remove_member', group_id=group.id, user_id=member.user.id) }}"
            onsubmit="return confirm('Remove {{ member.user.name }} from the group?');" class="d-inline">
            <button type="submit" class="btn btn-sm btn-outline-danger border-0" title="Remove member">
              <i class="fas fa-user-times"></i>
            </button>
          </form>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% else %}
  <div class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i>
    No members in this group yet.
  </div>
  {% endif %}
</div>

<div class="mt-4">
  <h5>Group Chat</h5>
  <div class="small text-muted mb-2">Status: <span id="chat-status">Connecting...</span></div>
  <div id="chat" data-group-id="{{ group.id }}" data-current-user-id="{{ current_user.id }}" class="chat-panel">
    <div id="emoji-picker-container"
      style="display: none; position: absolute; bottom: 70px; left: 15px; z-index: 1000;">
      <emoji-picker></emoji-picker>
    </div>
    <ul id="messages" class="chat-messages"></ul>
    <form id="chat-form" class="chat-input">
      <button type="button" id="emoji-btn" class="btn btn-outline-secondary me-2">ðŸ˜€</button>
      <input id="chat-input" class="form-control" placeholder="Type a message..." autocomplete="off">
      <input id="chat-file" type="file" class="form-control form-control-sm ms-2"
        style="max-width:120px; display: none;">
      <button type="button" id="upload-btn" class="btn btn-outline-secondary ms-2" title="Upload file">ðŸ“Ž</button>
      <button type="submit" class="btn btn-primary ms-2">
        <i class="fas fa-paper-plane"></i>
      </button>
    </form>
  </div>
</div>

<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.21.2/index.js"></script>
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>

{% endblock %}